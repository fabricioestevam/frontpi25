<!DOCTYPE html>
<html lang="pt-BR"> 
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="refresh" content="15">
    <title>BRT Recife</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(to bottom, #003366 0%, #0059b3 100%);
            color: #fff;
            min-height: 100vh;
            padding: 35px 40px;
        }

        .topo { margin-bottom: 40px; }
        .titulo-principal {
            font-size: 3.5em;
            font-weight: bold;
            margin-bottom: 15px;
            letter-spacing: 1px;
            color: #FFD700;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }

        .barra-info {
            background: #ffffff22;
            padding: 20px 30px;
            border-radius: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            backdrop-filter: blur(10px);
        }

        .item-info { color:#FFD700; font-weight:600; font-size:1.3em; }
        .relogio { font-size:1.6em; font-weight:bold; }

        .lista-onibus { margin-top:35px; }
        .card-onibus {
            background: #ffffff11;
            padding:30px 40px;
            margin-bottom:25px;
            border-radius:20px;
            display:flex;
            justify-content:space-between;
            align-items:center;
            border-left:8px solid #FFD700;
            backdrop-filter: blur(6px);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card-onibus:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.25);
        }

        .card-onibus.urgente { border-left-color:#C30B00; }
        .lado-esquerdo { flex:1; }
        .numero-linha { font-size:4em; font-weight:bold; color:#FFD700; line-height:0.9; margin-bottom:6px; }
        .nome-destino { font-size:1.6em; color:#ffffffcc; }
        .lado-direito { text-align:right; }
        .numero-tempo { font-size:4.5em; font-weight:bold; color:#FFD700; line-height:0.9; }
        .card-onibus.urgente .numero-tempo { color:#FF4D4D; }
        .texto-minutos { font-size:1.4em; color:#ffffffcc; font-weight:bold; margin-top:5px; }

        .sem-onibus {
            background: rgba(255,255,255,0.1);
            padding:70px 30px;
            border-radius:20px;
            text-align:center;
            margin-top:35px;
            color: #ffffffaa;
        }

        .rodape { text-align:center; margin-top:40px; font-size:1.2em; opacity:0.8; }

        .ponto-status {
            display:inline-block;
            width:14px; height:14px;
            border-radius:50%;
            background:#00FFAA;
            margin-right:8px;
            animation:pisca 2s infinite;
        }
        .ponto-status.offline { background:#FF4D4D; }
        @keyframes pisca { 0%,100%{opacity:1;} 50%{opacity:0.3;} }

        .carregando { text-align:center; padding:70px 30px; font-size:1.8em; }
        .spinner-load {
            border:6px solid rgba(255,255,255,0.25);
            border-top:6px solid #FFD700;
            border-radius:50%;
            width:60px; height:60px;
            animation:girar 1s linear infinite;
            margin:20px auto;
        }
        @keyframes girar { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }

        @media(max-width:768px){
            .numero-linha{font-size:3em;}
            .numero-tempo{font-size:3.5em;}
            .titulo-principal{font-size:3em;}
        }
        @media(max-width:480px){
            body{padding:20px 15px;}
            .numero-linha{font-size:2.5em;}
            .numero-tempo{font-size:3em;}
            .titulo-principal{font-size:2.5em;}
            .barra-info{flex-direction:column; gap:10px; padding:15px 20px;}
        }
    </style>
</head>
<body>
    <div class="topo">
        <div class="titulo-principal">PRÓXIMOS ÔNIBUS</div>
        <div class="barra-info">
            <div class="item-info">
                <span class="ponto-status" id="statusDot"></span>
                <span id="statusTexto">Verificando...</span>
            </div>
            <div class="item-info" id="paradaNome">Carregando...</div>
            <div class="item-info relogio" id="relogio">--:--</div>
        </div>
    </div>

    <div class="lista-onibus" id="listaOnibus">
        <div class="carregando">
            <div class="spinner-load"></div>
            <div>Carregando...</div>
        </div>
    </div>

    <div class="rodape" id="rodape">Última atualização: --</div>

    <script>
        const API = 'https://brt-webcam-server.onrender.com';

        const paradaNomes = {
            'poeta': 'Engenho Poeta',
            'getulio': 'Getúlio Vargas',
            'cordeiro': 'Cordeiro',
            'madalena': 'Madalena',
            'derby': 'Derby',
            'boa-vista': 'Boa Vista',
            'diario': 'Praça do Diário'
        };

        const nomesLinhas = {
            '262940': 'Terminal Integrado',
            '437': 'TI Caxangá',
            '2441': 'TI CDU',
            '2450': 'TI Camaragibe',
            '2444': 'TI Getúlio Vargas'
        };

        const ordemParadas = ['poeta','getulio','cordeiro','madalena','derby','boa-vista','diario'];
        const temposEntreParadas = {
            'poeta-getulio':2,
            'getulio-cordeiro':1,
            'cordeiro-madalena':1,
            'madalena-derby':2,
            'derby-boa-vista':2,
            'boa-vista-diario':1
        };

        const params = new URLSearchParams(window.location.search);
        const paradaAtual = params.get('parada') || 'poeta';
        document.getElementById('paradaNome').textContent = paradaNomes[paradaAtual] || 'BRT Recife';

        function atualizarRelogio() {
            const d = new Date();
            document.getElementById('relogio').textContent = 
                String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0');
        }

        function calcularTempoParaParada(paradaOrigem, paradaDestino){
            if(paradaOrigem===paradaDestino) return 0;
            const idxOrigem = ordemParadas.indexOf(paradaOrigem);
            const idxDestino = ordemParadas.indexOf(paradaDestino);
            if(idxOrigem>=idxDestino) return -1;
            let tempoTotal=0;
            for(let i=idxOrigem;i<idxDestino;i++){
                tempoTotal += temposEntreParadas[ordemParadas[i]+'-'+ordemParadas[i+1]]||2;
            }
            return tempoTotal;
        }

        async function buscarOnibus(){
            const statusDot = document.getElementById('statusDot');
            const statusTexto = document.getElementById('statusTexto');
            try{
                const resp = await fetch(API+'/ultimos',{method:'GET', headers:{'Accept':'application/json'}});
                if(!resp.ok) throw new Error('Servidor retornou '+resp.status);
                const dados = await resp.json();

                statusDot.classList.remove('offline');
                statusTexto.textContent='Sistema Ativo';
                mostrarOnibus(dados);

                document.getElementById('rodape').textContent =
                    'Última atualização: ' + new Date().toLocaleTimeString('pt-BR');
            }catch(erro){
                console.error('Erro completo:',erro);
                statusDot.classList.add('offline');
                statusTexto.textContent='Servidor Offline';
                mostrarErro(erro.message);
            }
        }

        function mostrarOnibus(dados){
            const lista = document.getElementById('listaOnibus');
            if(!dados || dados.length===0){
                lista.innerHTML = `<div class="sem-onibus">
                    <div class="texto-vazio">Nenhum ônibus detectado</div>
                </div>`;
                return;
            }

            lista.innerHTML='';

            dados.forEach(item=>{
                const linha = item.linha_detectada || 'Desconhecida';
                const nomeLinha = nomesLinhas[linha] || `Linha ${linha}`;
                const timestamp = new Date(item.timestamp);
                const paradaDeteccao = item.parada_origem || 'poeta';
                const minutosDecorridos = Math.floor((new Date() - timestamp)/60000);
                const tempoBase = item.previsao?.chega_em_min || 0;
                let tempoAjustado = Math.max(0, tempoBase + calcularTempoParaParada(paradaDeteccao, paradaAtual) - minutosDecorridos);
                if(tempoAjustado===0) tempoAjustado=1;

                const div = document.createElement('div');
                div.className='card-onibus';
                if(tempoAjustado<=2) div.className+=' urgente';

                div.innerHTML = `
                    <div class="lado-esquerdo">
                        <div class="numero-linha">${linha}</div>
                        <div class="nome-destino">${nomeLinha}</div>
                    </div>
                    <div class="lado-direito">
                        <div class="numero-tempo">${tempoAjustado}</div>
                        <div class="texto-minutos">${tempoAjustado===1?'MINUTO':'MINUTOS'}</div>
                    </div>
                `;
                lista.appendChild(div);
            });
        }

        function mostrarErro(msg){
            document.getElementById('listaOnibus').innerHTML=`
                <div class="sem-onibus">
                    <div class="texto-vazio">Erro de Conexão</div>
                    <div class="subtexto-vazio">${msg}<br>Aguarde e recarregue a página</div>
                </div>
            `;
        }

        setInterval(atualizarRelogio,1000);
        atualizarRelogio();
        buscarOnibus();
        setInterval(buscarOnibus,15000);
    </script>
</body>
</html>
